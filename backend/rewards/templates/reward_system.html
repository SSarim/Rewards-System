<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reward System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    const apiBaseUrl = "http://127.0.0.1:8000";

    // Helper function for API calls
    async function apiCall(endpoint, method, data) {
      try {
        const response = await fetch(`${apiBaseUrl}${endpoint}`, {
          method: method,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });
        return await response.json();
      } catch (error) {
        console.error(`Error calling ${endpoint}:`, error);
        return { error: "An Error has Mysteriously Appreared. Please try again later." };
      }
    }

    // Load user data (points and redemption history)
    async function loadUserData(userId) {
      // Fetch total points
      const pointsResponse = await apiCall("/get-points/", "POST", { user_id: userId });
      if (pointsResponse.error) {
        alert(pointsResponse.error);
        return;
      }
      document.getElementById("total-points").innerText = pointsResponse.total_points || 0;

      // Fetch redemption history
      const redemptionsResponse = await apiCall("/get-redemptions/", "POST", { user_id: userId });
      if (redemptionsResponse.error) {
        alert(redemptionsResponse.error);
        return;
      }
      const tableBody = document.getElementById("redemption-history-body");
      tableBody.innerHTML = ""; // Clear existing rows
      redemptionsResponse.redemption_history.forEach((item) => {
        const row = `
          <tr>
            <td>${item.reward.reward_description}</td>
            <td>${item.amount}</td>
            <td>${item.reward.is_active ? "Active" : "Inactive"}</td>
            <td>${item.reward.redeemed_date || "N/A"}</td>
          </tr>`;
        tableBody.innerHTML += row;
      });
    }

    // Redeem a reward
    async function redeemReward(userId, type) {
      const rewardDescription = document.getElementById("reward-description").value;
      const pointsRedeemed = parseInt(document.getElementById("points-redeemed").value, 10);
      const amount = parseFloat(document.getElementById("amount").value);

      if (!rewardDescription || !pointsRedeemed || isNaN(amount)) {
        alert("Please fill in all fields.");
        return;
      }

      const endpoint = type === "coupon" ? "/redeem-coupon/" : "/redeem-donation/";
      const payload = {
        user_id: userId,
        reward_description: rewardDescription,
        points_redeemed: pointsRedeemed,
        ...(type === "coupon" ? { coupon_amount: amount } : { donation_amount: amount }),
      };

      const response = await apiCall(endpoint, "POST", payload);
      if (response.error) {
        alert(response.error);
        return;
      }

      alert(response.message);
      loadUserData(userId); // Reload user data to reflect changes
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      const userId = 1; // Replace with dynamic user ID if needed
      loadUserData(userId);

      document.getElementById("redeem-coupon-btn").addEventListener("click", () => redeemReward(userId, "coupon"));
      document.getElementById("redeem-donation-btn").addEventListener("click", () => redeemReward(userId, "donation"));
    });
  </script>
</head>
<body>
    <div class="container mt-5">
      <!-- Header -->
      <h1 class="text-center mb-4 text-primary">Reward System</h1>
  
      <!-- Points Display -->
      <div class="row justify-content-center my-4">
        <div class="col-auto text-center">
          <h3 class="fw-bold">
            <span class="text-success">Total Points:</span> 
            <span id="total-points" class="text-dark">0</span>
          </h3>
        </div>
      </div>
  
      <div class="row gy-5">
        <!-- Redemption History -->
        <div class="col-md-6">
          <h4 class="text-secondary mb-3">Redemption History</h4>
          <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Redeemed Date</th>
                </tr>
              </thead>
              <tbody id="redemption-history-body">
                <!-- Dynamically populated rows -->
              </tbody>
            </table>
          </div>
        </div>
  
        <!-- Redeem Reward -->
        <div class="col-md-6">
          <h4 class="text-secondary mb-3">Redeem Reward</h4>
          <form>
            <!-- Reward Description -->
            <div class="mb-3">
              <label for="reward-description" class="form-label fw-bold">Reward Description</label>
              <input
                type="text"
                id="reward-description"
                class="form-control border border-primary"
                placeholder="Enter reward description"
              />
            </div>
  
            <!-- Points Redeemed -->
            <div class="mb-3">
              <label for="points-redeemed" class="form-label fw-bold">Points Redeemed</label>
              <input
                type="number"
                id="points-redeemed"
                class="form-control border border-primary"
                placeholder="Enter points to redeem"
              />
            </div>
  
            <!-- Amount -->
            <div class="mb-3">
              <label for="amount" class="form-label fw-bold">Amount</label>
              <input
                type="number"
                step="0.01"
                id="amount"
                class="form-control border border-primary"
                placeholder="Enter amount"
              />
            </div>
  
            <!-- Buttons -->
            <div class="d-flex gap-2">
              <button
                type="button"
                id="redeem-coupon-btn"
                class="btn btn-primary w-50 fw-bold"
              >
                <i class="bi bi-cash"></i> Redeem Coupon
              </button>
              <button
                type="button"
                id="redeem-donation-btn"
                class="btn btn-secondary w-50 fw-bold"
              >
                <i class="bi bi-heart"></i> Redeem Donation
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css"
    />
  </body>
  
</html>
